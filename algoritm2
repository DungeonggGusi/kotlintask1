val charsetsToTry = listOf("UTF-8", "UTF-16LE", "UTF-16BE", "Windows-1251", "ISO-8859-1")

fun tryDetectCharset(file: File): Charset? {
    charsetsToTry.forEach { csName ->
        try {
            val charset = Charset.forName(csName)
            val decoder = charset.newDecoder()
            decoder.onMalformedInput(CodingErrorAction.REPORT)
            decoder.onUnmappableCharacter(CodingErrorAction.REPORT)
            file.inputStream().bufferedReader(decoder).use { reader ->
                reader.readLines() // если ошибок нет, значит кодировка подходит
            }
            return charset
        } catch (e: Exception) {
            // Ошибка — значит кодировка не подходит
        }
    }
    return null
}
